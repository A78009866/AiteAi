<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flutter Project Commander</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
    <style>
        :root { --bg: #1e1e1e; --sidebar: #252526; --accent: #007acc; --text: #d4d4d4; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        #sidebar { width: 250px; background: var(--sidebar); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .config-box { padding: 15px; background: #2d2d2d; border-bottom: 1px solid #333; }
        .config-box input { width: 90%; background: #3c3c3c; border: 1px solid #555; color: white; padding: 5px; margin-bottom: 5px; border-radius: 3px; }
        .file-tree { flex: 1; overflow-y: auto; padding: 10px; }
        .file-item { cursor: pointer; padding: 4px 8px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item:hover { background: #37373d; }
        .file-item.folder { color: #dcb67a; font-weight: bold; }
        .file-item.file { color: #9cdcfe; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø±Ø± */
        #main { flex: 1; display: flex; flex-direction: column; }
        #toolbar { height: 50px; background: var(--sidebar); border-bottom: 1px solid #333; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
        #editor-container { flex: 1; position: relative; }
        #editor { position: absolute; top: 0; right: 0; bottom: 0; left: 0; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        button { background: #3c3c3c; color: white; border: 1px solid #555; padding: 6px 12px; cursor: pointer; border-radius: 3px; transition: 0.2s; }
        button:hover { background: #505050; }
        button.primary { background: var(--accent); border-color: var(--accent); }
        button.primary:hover { background: #0062a3; }
        button.danger { background: #a32828; border-color: #851e1e; }

        /* Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        #status { margin-left: auto; font-size: 13px; color: #888; }
        .loader { display: none; width: 16px; height: 16px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="config-box">
            <small>GitHub Configuration</small>
            <input type="text" id="repoOwner" placeholder="Username (e.g. A78009866)">
            <input type="text" id="repoName" placeholder="Repo Name (e.g. AiteAi)">
            <input type="password" id="token" placeholder="GitHub Personal Token">
            <button onclick="loadRepo()" style="width:100%">ğŸ“‚ Load Project</button>
        </div>
        <div class="file-tree" id="fileTree">
            <div style="text-align:center; margin-top:20px; color:#666;">Load a repo to start</div>
        </div>
    </div>

    <div id="main">
        <div id="toolbar">
            <button class="danger" onclick="createNewProject()">âš¡ Create New Flutter Project</button>
            <button class="primary" onclick="saveCurrentFile()">ğŸ’¾ Save Changes</button>
            <button onclick="triggerBuild()">ğŸ”¨ Rebuild Web/APK</button>
            <button onclick="downloadZip()">ğŸ“¦ Download ZIP</button>
            <a id="previewLink" href="#" target="_blank" style="display:none; margin-left:10px; color:#4caf50; text-decoration:none;">ğŸŒ Open Preview</a>
            <div id="status">Ready</div>
            <div class="loader" id="loader"></div>
        </div>
        <div id="editor-container">
            <div id="editor"></div>
        </div>
    </div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±Ø±
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/dart");
        editor.setFontSize(14);

        let currentFileSha = null;
        let currentFilePath = null;

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ API
        async function githubAPI(endpoint, method = 'GET', body = null) {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            const token = document.getElementById('token').value;
            
            if (!owner || !repo || !token) {
                alert("Please fill in Username, Repo Name, and Token!");
                return null;
            }

            document.getElementById('status').innerText = "Processing...";
            document.getElementById('loader').style.display = "block";

            const url = `https://api.github.com/repos/${owner}/${repo}${endpoint}`;
            const headers = {
                'Authorization': `token ${token}`,
                'Accept': 'application/vnd.github.v3+json'
            };

            try {
                const options = { method, headers };
                if (body) options.body = JSON.stringify(body);
                const response = await fetch(url, options);
                
                document.getElementById('status').innerText = "Ready";
                document.getElementById('loader').style.display = "none";
                
                if (!response.ok) throw new Error(`Error: ${response.statusText}`);
                return method === 'GET' ? await response.json() : response;
            } catch (error) {
                alert(error.message);
                document.getElementById('status').innerText = "Error";
                document.getElementById('loader').style.display = "none";
                return null;
            }
        }

        // 1. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù„ÙØ§Øª
        async function loadRepo(path = '') {
            const data = await githubAPI(`/contents/${path}`);
            if (!data) return;

            const tree = document.getElementById('fileTree');
            if (path === '') {
                tree.innerHTML = ''; // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ø°Ø±
                // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                const owner = document.getElementById('repoOwner').value;
                const repo = document.getElementById('repoName').value;
                const link = document.getElementById('previewLink');
                link.href = `https://${owner}.github.io/${repo}/`;
                link.style.display = 'inline-block';
            }

            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
            data.sort((a, b) => (a.type === b.type ? 0 : a.type === 'dir' ? -1 : 1));

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `file-item ${item.type === 'dir' ? 'folder' : 'file'}`;
                div.innerText = (item.type === 'dir' ? 'ğŸ“ ' : 'ğŸ“„ ') + item.name;
                
                if (item.type === 'dir') {
                    div.onclick = () => loadRepo(item.path); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ (ØªØ¨Ø³ÙŠØ· Ù„Ù„Ø¹Ø±Ø¶)
                } else {
                    div.onclick = () => openFile(item.path);
                }
                tree.appendChild(div);
            });
        }

        // 2. ÙØªØ­ Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø­Ø±Ø±
        async function openFile(path) {
            const data = await githubAPI(`/contents/${path}`);
            if (!data) return;

            // ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Base64
            const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
            
            editor.setValue(content, -1); // -1 Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù…Ø¤Ø´Ø± Ù„Ù„Ø¨Ø¯Ø§ÙŠØ©
            
            // ØªØ­Ø¯ÙŠØ¯ Ù„ØºØ© Ø§Ù„Ù…Ø­Ø±Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù…ØªØ¯Ø§Ø¯
            if (path.endsWith('.dart')) editor.session.setMode("ace/mode/dart");
            else if (path.endsWith('.yaml')) editor.session.setMode("ace/mode/yaml");
            else if (path.endsWith('.html')) editor.session.setMode("ace/mode/html");
            else editor.session.setMode("ace/mode/text");

            currentFilePath = path;
            currentFileSha = data.sha; // Ù†Ø­ØªØ§Ø¬ SHA Ù„Ù„ØªØ­Ø¯ÙŠØ«
            document.getElementById('status').innerText = `Editing: ${path}`;
        }

        // 3. Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
        async function saveCurrentFile() {
            if (!currentFilePath) return alert("No file selected!");
            
            const content = editor.getValue();
            // ØªØ´ÙÙŠØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¥Ù„Ù‰ Base64
            const encodedContent = btoa(new TextEncoder().encode(content).reduce((data, byte) => data + String.fromCharCode(byte), ''));

            const body = {
                message: `Update ${currentFilePath} via Web Editor`,
                content: encodedContent,
                sha: currentFileSha
            };

            const res = await githubAPI(`/contents/${currentFilePath}`, 'PUT', body);
            if (res && res.ok) {
                const json = await res.json();
                currentFileSha = json.content.sha; // ØªØ­Ø¯ÙŠØ« SHA Ø§Ù„Ø¬Ø¯ÙŠØ¯
                alert("File Saved Successfully!");
            }
        }

        // 4. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø¯ÙŠØ¯ (ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§ÙƒØ´Ù†)
        async function createNewProject() {
            if(!confirm("Warning: This will DELETE all current files and create a fresh Flutter project. Continue?")) return;
            
            // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù€ workflow Ø¯Ù‚ÙŠÙ‚Ø§Ù‹
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØªØ±Ø¶ Ø£Ù† Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù‡Ùˆ auto-generator.yml ÙƒÙ…Ø§ Ø§ØªÙÙ‚Ù†Ø§
            const body = { ref: 'main' }; 
            const res = await githubAPI(`/actions/workflows/auto-generator.yml/dispatches`, 'POST', body);
            
            if (res && res.ok) {
                alert("Build started! It will take 2-3 minutes. Check GitHub Actions tab or wait and click Rebuild.");
            }
        }

        // 5. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡ (ØªØ´ØºÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø§ÙƒØ´Ù†)
        async function triggerBuild() {
             // ÙŠÙ…ÙƒÙ†Ù†Ø§ ØªØ´ØºÙŠÙ„ Ù†ÙØ³ Ø§Ù„Ø§ÙƒØ´Ù† Ù„Ø£Ù†Ù‡ ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ù„Ø¨Ù†Ø§Ø¡ ÙˆØ§Ù„Ù†Ø´Ø±
            const body = { ref: 'main' };
            const res = await githubAPI(`/actions/workflows/auto-generator.yml/dispatches`, 'POST', body);
            if (res && res.ok) alert("Rebuild triggered! Wait a few minutes for the update.");
        }

        // 6. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ZIP
        function downloadZip() {
            const owner = document.getElementById('repoOwner').value;
            const repo = document.getElementById('repoName').value;
            if (!owner || !repo) return alert("Load repo first!");
            window.open(`https://github.com/${owner}/${repo}/archive/refs/heads/main.zip`);
        }
    </script>
</body>
</html>
