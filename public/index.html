<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aite.studio | Cloud Flutter IDE</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-sidebar: #252526;
            --bg-activity: #333333;
            --accent: #007acc;
            --text-main: #cccccc;
            --text-header: #ffffff;
            --border: #3e3e42;
            --hover: #2a2d2e;
        }

        body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Header */
        header { height: 40px; background: #3c3c3c; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 13px; border-bottom: 1px solid #000; }
        .brand { font-weight: 700; color: #fff; display: flex; align-items: center; gap: 8px; }
        .brand i { color: var(--accent); }
        .controls { display: flex; gap: 10px; }
        
        /* Layout */
        #workspace { display: flex; flex: 1; height: calc(100vh - 40px); }
        
        /* Sidebar */
        #sidebar { width: 300px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .section-title { padding: 10px 15px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #bbb; display: flex; justify-content: space-between; align-items: center; }
        .section-actions i { cursor: pointer; margin-left: 8px; font-size: 12px; }
        .section-actions i:hover { color: #fff; }

        /* Configuration Form */
        #config-panel { padding: 15px; background: var(--bg-dark); border-bottom: 1px solid var(--border); }
        input { width: 100%; box-sizing: border-box; background: #3c3c3c; border: 1px solid #3c3c3c; color: white; padding: 6px; margin-bottom: 8px; border-radius: 2px; outline: none; font-size: 12px; }
        input:focus { border-color: var(--accent); }
        
        /* File Tree */
        #file-explorer { flex: 1; overflow-y: auto; font-family: 'JetBrains Mono', monospace; font-size: 13px; }
        .tree-item { padding: 4px 10px; cursor: pointer; white-space: nowrap; display: flex; align-items: center; gap: 6px; user-select: none; }
        .tree-item:hover { background: var(--hover); }
        .tree-item.active { background: #37373d; color: #fff; }
        .tree-icon { width: 16px; text-align: center; }
        .fa-folder { color: #dcb67a; }
        .fa-file-code { color: #4fc1ff; }
        .fa-file-image { color: #ce9178; }
        .fa-chevron-right { font-size: 10px; transition: 0.2s; }
        .rotate { transform: rotate(90deg); }

        /* Editor Area */
        #editor-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-dark); }
        #tabs-bar { height: 35px; background: var(--bg-dark); display: flex; overflow-x: auto; border-bottom: 1px solid var(--bg-dark); }
        .tab { background: #2d2d2d; padding: 0 15px; display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; border-right: 1px solid #1e1e1e; color: #969696; min-width: 120px; }
        .tab.active { background: #1e1e1e; color: #fff; border-top: 1px solid var(--accent); }
        .tab-close { font-size: 12px; border-radius: 3px; padding: 2px; }
        .tab-close:hover { background: #444; color: #fff; }
        
        #monaco-container { flex: 1; position: relative; }

        /* Buttons & Status */
        .btn { border: none; padding: 6px 12px; border-radius: 2px; cursor: pointer; font-size: 12px; font-family: inherit; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #005f9e; }
        .btn-success { background: #198754; color: white; }
        .btn-danger { background: #c93c3c; color: white; }
        .btn-secondary { background: #3c3c3c; color: #ccc; }
        .btn-secondary:hover { background: #4b4b4b; }

        /* Loader */
        #loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb { background: #424242; border-radius: 5px; border: 2px solid var(--bg-sidebar); }
        ::-webkit-scrollbar-thumb:hover { background: #4f4f4f; }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <i class="fa-solid fa-layer-group"></i> Aite.studio
        </div>
        <div class="controls" id="project-controls" style="display:none;">
            <span id="status-text" style="margin-right:15px; color: #888;">Ready</span>
            <button class="btn btn-secondary" onclick="createNewFilePrompt()"><i class="fa-solid fa-file-circle-plus"></i> New File</button>
            <button class="btn btn-danger" onclick="triggerBuild()"><i class="fa-solid fa-hammer"></i> Build & Deploy</button>
            <button class="btn btn-primary" onclick="saveCurrentFile()"><i class="fa-regular fa-floppy-disk"></i> Save</button>
            <a id="preview-btn" href="#" target="_blank" class="btn btn-success" style="text-decoration: none; display:none;"><i class="fa-solid fa-play"></i> Run Preview</a>
        </div>
    </header>

    <div id="workspace">
        <div id="sidebar">
            <div id="config-panel">
                <input type="text" id="repoOwner" placeholder="GitHub Username (e.g. A78009866)">
                <input type="text" id="repoName" placeholder="Repository Name (e.g. AiteAi)">
                <input type="password" id="token" placeholder="GitHub Personal Access Token">
                <button class="btn btn-primary" onclick="loadProject()" style="width:100%; justify-content: center;">Connect to Repo</button>
            </div>
            
            <div class="section-title">
                <span>EXPLORER</span>
                <div class="section-actions">
                    <i class="fa-solid fa-rotate-right" title="Refresh" onclick="refreshTree()"></i>
                </div>
            </div>
            <div id="file-explorer">
                <div style="padding: 20px; text-align: center; color: #666; font-size: 12px;">
                    Connect to a repository to start coding.
                </div>
            </div>
        </div>

        <div id="editor-area">
            <div id="tabs-bar">
                </div>
            <div id="monaco-container"></div>
        </div>
    </div>

    <div id="loader-overlay">
        <div class="spinner"></div>
        <div id="loader-msg" style="color:white; font-size:14px;">Processing...</div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>

    <script>
        // --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Monaco Editor ---
        let editor;
        let currentFile = { path: null, sha: null };
        
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('monaco-container'), {
                value: "// Select a file to edit\n",
                language: 'dart',
                theme: 'vs-dark',
                automaticLayout: true,
                fontSize: 14,
                fontFamily: 'JetBrains Mono',
                minimap: { enabled: true }
            });

            // Ø§Ø®ØªØµØ§Ø± Ctrl+S
            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KeyS, function() {
                saveCurrentFile();
            });
        });

        // --- 2. Ø¥Ø¯Ø§Ø±Ø© GitHub API ---
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        function getAuth() {
            return {
                owner: document.getElementById('repoOwner').value.trim(),
                repo: document.getElementById('repoName').value.trim(),
                token: document.getElementById('token').value.trim()
            };
        }

        async function apiRequest(endpoint, method = 'GET', body = null) {
            const { owner, repo, token } = getAuth();
            if (!owner || !repo || !token) { alert("Please enter credentials"); return null; }

            const loader = document.getElementById('loader-overlay');
            if(method !== 'GET') loader.style.display = 'flex'; // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙ‚Ø· Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø«Ù‚ÙŠÙ„Ø©

            try {
                const opts = {
                    method,
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    }
                };
                if (body) opts.body = JSON.stringify(body);

                const res = await fetch(`https://api.github.com/repos/${owner}/${repo}${endpoint}`, opts);
                
                if(method !== 'GET') loader.style.display = 'none';

                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message);
                }
                return method === 'GET' ? await res.json() : res;
            } catch (e) {
                loader.style.display = 'none';
                console.error(e);
                alert("Error: " + e.message);
                return null;
            }
        }

        // --- 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª ---

        async function loadProject() {
            const { owner, repo } = getAuth();
            if (!owner) return;

            document.getElementById('project-controls').style.display = 'flex';
            document.getElementById('config-panel').style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©
            
            // ØªØ­Ø¯ÙŠØ« Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
            const preview = document.getElementById('preview-btn');
            preview.href = `https://${owner}.github.io/${repo}/`;
            preview.style.display = 'flex';

            await refreshTree();
        }

        async function refreshTree() {
            // Ù†Ø³ØªØ®Ø¯Ù… Recursive Tree API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© (Ø£Ø³Ø±Ø¹)
            const branchData = await apiRequest(`/branches/main`);
            if(!branchData) return;
            
            const treeSha = branchData.commit.commit.tree.sha;
            const treeData = await apiRequest(`/git/trees/${treeSha}?recursive=1`);
            
            if(treeData && treeData.tree) {
                renderFileTree(treeData.tree);
            }
        }

        function renderFileTree(items) {
            const container = document.getElementById('file-explorer');
            container.innerHTML = '';
            
            // ØªØ±ØªÙŠØ¨: Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø«Ù… Ø§Ù„Ù…Ù„ÙØ§Øª
            items.sort((a, b) => {
                if (a.type === b.type) return a.path.localeCompare(b.path);
                return a.type === 'tree' ? -1 : 1;
            });

            items.forEach(item => {
                if (item.type !== 'blob' && item.type !== 'tree') return; // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ÙØ±Ø¹ÙŠØ©
                
                const el = document.createElement('div');
                el.className = 'tree-item';
                // Ù…Ø³Ø§ÙØ© Ø¨Ø§Ø¯Ø¦Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…Ù‚
                const depth = item.path.split('/').length - 1;
                el.style.paddingLeft = `${10 + (depth * 15)}px`;

                const icon = item.type === 'tree' ? 'fa-folder' : getFileIcon(item.path);
                
                el.innerHTML = `
                    <div class="tree-icon"><i class="fa-solid ${icon}"></i></div>
                    <span>${item.path.split('/').pop()}</span>
                `;

                el.onclick = () => {
                    if (item.type === 'blob') openFile(item.path);
                };

                container.appendChild(el);
            });
        }

        function getFileIcon(filename) {
            if (filename.endsWith('.dart')) return 'fa-file-code';
            if (filename.endsWith('.yaml')) return 'fa-file-lines';
            if (filename.endsWith('.html')) return 'fa-html5';
            if (filename.endsWith('.json')) return 'fa-file-code';
            if (filename.endsWith('.png')) return 'fa-file-image';
            return 'fa-file';
        }

        // --- 4. ÙØªØ­ ÙˆØ­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª ---

        async function openFile(path) {
            document.getElementById('loader-msg').innerText = "Loading File...";
            document.getElementById('loader-overlay').style.display = 'flex';

            const data = await apiRequest(`/contents/${path}`);
            document.getElementById('loader-overlay').style.display = 'none';
            
            if (!data) return;

            // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± Ù…Ø¹ Ø¯Ø¹Ù… UTF-8
            const content = new TextDecoder().decode(Uint8Array.from(atob(data.content), c => c.charCodeAt(0)));
            
            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ©
            let lang = 'plaintext';
            if (path.endsWith('.dart')) lang = 'dart';
            if (path.endsWith('.yaml')) lang = 'yaml';
            if (path.endsWith('.json')) lang = 'json';
            if (path.endsWith('.html')) lang = 'html';

            monaco.editor.setModelLanguage(editor.getModel(), lang);
            editor.setValue(content);
            
            currentFile = { path: path, sha: data.sha };
            updateTabs(path);
            document.getElementById('status-text').innerText = `Editing: ${path}`;
        }

        function updateTabs(path) {
            const tabs = document.getElementById('tabs-bar');
            tabs.innerHTML = `
                <div class="tab active">
                    <i class="fa-solid ${getFileIcon(path)}"></i>
                    <span>${path.split('/').pop()}</span>
                    <i class="fa-solid fa-xmark tab-close"></i>
                </div>
            `;
        }

        async function saveCurrentFile() {
            if (!currentFile.path) return alert("No file open!");

            const content = editor.getValue();
            // ØªØ´ÙÙŠØ±
            const encoded = btoa(new TextEncoder().encode(content).reduce((data, byte) => data + String.fromCharCode(byte), ''));

            const body = {
                message: `Update ${currentFile.path} via Aite.studio`,
                content: encoded,
                sha: currentFile.sha
            };

            const res = await apiRequest(`/contents/${currentFile.path}`, 'PUT', body);
            if (res) {
                const json = await res.json();
                currentFile.sha = json.content.sha;
                // ÙˆÙ…ÙŠØ¶ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ÙØ¸
                const btn = document.querySelector('.btn-primary');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved';
                setTimeout(() => btn.innerHTML = originalText, 2000);
            }
        }

        // --- 5. Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ ---
        async function createNewFilePrompt() {
            const fileName = prompt("Enter file path (e.g. lib/new_screen.dart):");
            if(!fileName) return;

            const content = "// New File";
            const encoded = btoa(content);
            
            const body = {
                message: `Create ${fileName}`,
                content: encoded
            };

            const res = await apiRequest(`/contents/${fileName}`, 'PUT', body);
            if(res) {
                await refreshTree(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                openFile(fileName); // ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙÙˆØ±Ø§Ù‹
            }
        }

        // --- 6. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ù†Ø§Ø¡ ---
        async function triggerBuild() {
            const confirmBuild = confirm("Trigger new build? This will verify project files and build Web/Android versions.");
            if(!confirmBuild) return;

            // Ø§Ø³Ù… Ù…Ù„Ù Ø§Ù„Ù€ workflow ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø±ÙŠØ¨Ùˆ
            const workflowFile = 'flutter_ci.yml'; // ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù…ÙŠØ© Ø§Ù„Ù…Ù„Ù ÙÙŠ Ø§Ù„Ø±ÙŠØ¨Ùˆ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù…
            
            const body = { ref: 'main' };
            const res = await apiRequest(`/actions/workflows/${workflowFile}/dispatches`, 'POST', body);
            
            if(res && res.ok) {
                alert("ğŸš€ Build Started! Changes will appear in a few minutes.\nCheck the Actions tab in GitHub for details.");
            }
        }

    </script>
</body>
</html>
